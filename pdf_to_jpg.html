<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 轉 JPG 轉換工具 - PurePDF</title>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                    }
                }
            }
        };
    </script>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 引入共用佈局腳本 -->
    <script src="layout.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header will be injected here by layout.js -->

    <!-- Main Content (React Root) -->
    <main class="flex-grow p-4 md:p-8 flex flex-col items-center">
        <div id="root" class="w-full max-w-[85rem]"></div>
    </main>

    <!-- Footer will be injected here by layout.js -->

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo } = React;

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.min.js';

        const PAPER_SIZES = { 'A5': { width: 5.83, height: 8.27 }, 'A4': { width: 8.27, height: 11.69 }, 'A3': { width: 11.69, height: 16.53 }, 'Letter': { width: 8.5, height: 11.0 }, 'Legal': { width: 8.5, height: 14.0 } };
        const DPI_OPTIONS = [ { value: 72, label: '72 DPI (螢幕瀏覽)' }, { value: 150, label: '150 DPI (電子書/普通列印)' }, { value: 300, label: '300 DPI (高品質列印)' } ];

        const IconUpload = () => <i className="fa-solid fa-cloud-arrow-up text-4xl"></i>;
        const IconImage = () => <i className="fa-regular fa-image"></i>;
        const IconSettings = () => <i className="fa-solid fa-sliders"></i>;
        const IconDownload = () => <i className="fa-solid fa-download"></i>;
        const IconCheck = () => <i className="fa-solid fa-check"></i>;
        const IconAlert = () => <i className="fa-solid fa-triangle-exclamation"></i>;
        const IconPdf = () => <i className="fa-regular fa-file-pdf"></i>;

        function App() {
            const [file, setFile] = useState(null);
            const [pdfDoc, setPdfDoc] = useState(null);
            const [totalPages, setTotalPages] = useState(0);
            
            const [pageMode, setPageMode] = useState('all');
            const [rangeInput, setRangeInput] = useState('');
            const [dimensionMode, setDimensionMode] = useState('paper');
            const [maxWidth, setMaxWidth] = useState(1920);
            const [baseScale, setBaseScale] = useState(2.0);
            const [selectedPaper, setSelectedPaper] = useState('A4');
            const [selectedDPI, setSelectedDPI] = useState(150);
            const [imgQuality, setImgQuality] = useState(0.85);

            const [isProcessing, setIsProcessing] = useState(false);
            const [progress, setProgress] = useState({ current: 0, total: 0, message: '' });
            const [error, setError] = useState(null);
            const [result, setResult] = useState(null);

            const fileInputRef = useRef(null);

            const handleFileChange = async (e) => {
                const selectedFile = e.target.files[0];
                if (!selectedFile) return;
                if (selectedFile.type !== 'application/pdf') { setError('請上傳 PDF 格式的檔案'); return; }

                setFile(selectedFile); setError(null); setResult(null); setIsProcessing(true);
                setProgress({ current: 0, total: 0, message: '分析檔案中...' });

                try {
                    const arrayBuffer = await selectedFile.arrayBuffer();
                    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                    const doc = await loadingTask.promise;
                    setPdfDoc(doc); setTotalPages(doc.numPages); setIsProcessing(false);
                } catch (err) {
                    console.error(err); setError('無法讀取 PDF 檔案，檔案可能已損壞。'); setIsProcessing(false);
                }
            };

            const parsePageRange = (total) => {
                if (pageMode === 'all') return Array.from({ length: total }, (_, i) => i + 1);
                const pages = new Set();
                const parts = rangeInput.split(/[,;]/);
                parts.forEach(part => {
                    const p = part.trim(); if (!p) return;
                    if (p.includes('-')) {
                        const [start, end] = p.split('-').map(num => parseInt(num, 10));
                        if (!isNaN(start) && !isNaN(end)) {
                            const min = Math.max(1, Math.min(start, end)); const max = Math.min(total, Math.max(start, end));
                            for (let i = min; i <= max; i++) pages.add(i);
                        }
                    } else {
                        const num = parseInt(p, 10); if (!isNaN(num) && num >= 1 && num <= total) pages.add(num);
                    }
                });
                return Array.from(pages).sort((a, b) => a - b);
            };

            const getPaperDimensionsText = () => {
                const paper = PAPER_SIZES[selectedPaper];
                const longEdgePx = Math.round(paper.height * selectedDPI);
                const shortEdgePx = Math.round(paper.width * selectedDPI);
                return `${selectedPaper} @ ${selectedDPI} DPI (約 ${shortEdgePx} x ${longEdgePx} px)`;
            };

            const startConversion = async () => {
                if (!pdfDoc) return;
                setResult(null); setError(null); setIsProcessing(true);
                const targetPages = parsePageRange(totalPages);
                if (targetPages.length === 0) { setError('請選擇有效的頁數範圍'); setIsProcessing(false); return; }

                try {
                    let zip = null;
                    if (targetPages.length > 1) zip = new JSZip();

                    for (let i = 0; i < targetPages.length; i++) {
                        const pageNum = targetPages[i];
                        setProgress({ current: i + 1, total: targetPages.length, message: `正在處理第 ${pageNum} 頁...` });
                        const page = await pdfDoc.getPage(pageNum);
                        const defaultViewport = page.getViewport({ scale: 1.0 });
                        let renderScale = 1.0;

                        if (dimensionMode === 'pixel') {
                            renderScale = baseScale;
                            const testWidth = defaultViewport.width * baseScale; const testHeight = defaultViewport.height * baseScale;
                            if (maxWidth && (testWidth > maxWidth || testHeight > maxWidth)) {
                                const scaleW = maxWidth / defaultViewport.width; const scaleH = maxWidth / defaultViewport.height; renderScale = Math.min(scaleW, scaleH);
                            }
                        } else {
                            const paper = PAPER_SIZES[selectedPaper];
                            const paperLongEdgeInches = Math.max(paper.width, paper.height);
                            const targetLongEdgePx = paperLongEdgeInches * selectedDPI;
                            const pdfLongEdge = Math.max(defaultViewport.width, defaultViewport.height);
                            renderScale = targetLongEdgePx / pdfLongEdge;
                        }

                        const viewport = page.getViewport({ scale: renderScale });
                        const canvas = document.createElement('canvas'); const context = canvas.getContext('2d');
                        canvas.width = viewport.width; canvas.height = viewport.height;
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', imgQuality));
                        const fileName = `${file.name.replace('.pdf', '')}_p${String(pageNum).padStart(3, '0')}.jpg`;

                        if (targetPages.length === 1) {
                            const url = URL.createObjectURL(blob); setResult({ type: 'single', url, filename: fileName });
                        } else {
                            zip.file(fileName, blob);
                        }
                    }

                    if (targetPages.length > 1) {
                        setProgress({ current: targetPages.length, total: targetPages.length, message: '正在打包壓縮檔...' });
                        const content = await zip.generateAsync({ type: 'blob' });
                        const url = URL.createObjectURL(content);
                        const zipName = `${file.name.replace('.pdf', '')}_images.zip`;
                        setResult({ type: 'zip', url, filename: zipName });
                    }
                } catch (err) {
                    console.error(err); setError('轉換過程中發生錯誤: ' + err.message);
                } finally { setIsProcessing(false); }
            };

            return (
                <div className="w-full bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden flex flex-col min-h-[600px]">
                    
                    {/* Toolbar Header (Unified Style) */}
                    <div className="bg-white border-b border-gray-100 p-4 md:p-6 flex items-center justify-between">
                        <h1 className="text-2xl font-bold flex items-center gap-2 text-gray-800">
                            <span className="text-blue-600"><IconImage /></span>
                            PDF 轉 JPG 工具
                        </h1>
                        {/* Right side controls or status could go here if needed */}
                        <div className="text-sm text-gray-500 hidden md:block">
                            本地端運算・自動調整尺寸・批次打包
                        </div>
                    </div>

                    {/* Card Body */}
                    <div className="p-4 md:p-8 flex-grow bg-slate-50/30">
                        {/* Inner Container to limit width for readability on ultra-wide screens */}
                        <div className="max-w-5xl mx-auto h-full flex flex-col">
                            {!file ? (
                                <div className="h-full flex flex-col items-center justify-center py-10 md:py-20">
                                    <div 
                                        onClick={() => fileInputRef.current.click()} 
                                        className="border-2 border-dashed border-slate-300 rounded-xl p-12 flex flex-col items-center justify-center text-slate-500 hover:bg-blue-50 hover:border-blue-400 transition-all cursor-pointer max-w-xl w-full group bg-white"
                                    >
                                        <input type="file" accept="application/pdf" className="hidden" ref={fileInputRef} onChange={handleFileChange} />
                                        <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center text-blue-500 mb-6 group-hover:scale-110 transition-transform">
                                            <IconUpload />
                                        </div>
                                        <p className="text-xl font-bold text-slate-700 mb-2">點擊或拖放 PDF 檔案</p>
                                        <p className="text-sm text-slate-400">純前端處理，檔案不離手</p>
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-6 animate-fade-in w-full">
                                    {/* File Info Bar */}
                                    <div className="flex flex-col md:flex-row items-start md:items-center justify-between bg-white p-4 rounded-xl border border-slate-200 shadow-sm gap-4">
                                        <div className="flex items-center gap-4">
                                            <div className="bg-red-100 text-red-600 w-12 h-12 rounded-lg text-2xl flex items-center justify-center flex-shrink-0">
                                                <IconPdf />
                                            </div>
                                            <div>
                                                <h3 className="font-bold text-slate-700 text-lg">{file.name}</h3>
                                                <p className="text-sm text-slate-500">共 {totalPages} 頁 / {(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                            </div>
                                        </div>
                                        <button 
                                            onClick={() => { setFile(null); setPdfDoc(null); setResult(null); }} 
                                            className="px-4 py-2 text-sm text-red-600 bg-red-50 hover:bg-red-100 rounded-lg font-medium transition-colors w-full md:w-auto"
                                        >
                                            移除檔案
                                        </button>
                                    </div>

                                    {/* Settings Grid */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        {/* Left: Page Selection */}
                                        <div className="bg-white border border-slate-200 p-6 rounded-xl shadow-sm h-full">
                                            <div className="flex items-center gap-2 mb-6 text-slate-800 font-bold border-b border-slate-100 pb-3">
                                                <span className="text-blue-600"><IconSettings /></span> 頁面選擇
                                            </div>
                                            <div className="space-y-4">
                                                <label className="flex items-center gap-3 cursor-pointer group p-2 hover:bg-slate-50 rounded-lg transition-colors">
                                                    <input type="radio" name="pageMode" checked={pageMode === 'all'} onChange={() => setPageMode('all')} className="w-5 h-5 text-blue-600 border-slate-300 focus:ring-blue-500" />
                                                    <span className="text-slate-700 font-medium">全部頁面</span>
                                                </label>
                                                <div className="group p-2 hover:bg-slate-50 rounded-lg transition-colors">
                                                    <label className="flex items-center gap-3 cursor-pointer mb-2">
                                                        <input type="radio" name="pageMode" checked={pageMode === 'range'} onChange={() => setPageMode('range')} className="w-5 h-5 text-blue-600 border-slate-300 focus:ring-blue-500" />
                                                        <span className="text-slate-700 font-medium">自訂範圍</span>
                                                    </label>
                                                    {pageMode === 'range' && (
                                                        <div className="pl-8 animate-fade-in">
                                                            <input 
                                                                type="text" 
                                                                placeholder="例如: 1, 3-5, 8" 
                                                                value={rangeInput} 
                                                                onChange={(e) => setRangeInput(e.target.value)} 
                                                                className="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-shadow" 
                                                            />
                                                            <p className="text-xs text-slate-400 mt-2">目前將輸出: <span className="font-bold text-blue-600">{parsePageRange(totalPages).length}</span> 頁</p>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Right: Image Settings */}
                                        <div className="bg-white border border-slate-200 p-6 rounded-xl shadow-sm h-full">
                                            <div className="flex items-center gap-2 mb-6 text-slate-800 font-bold border-b border-slate-100 pb-3">
                                                <span className="text-blue-600"><IconSettings /></span> 影像設定
                                            </div>
                                            <div>
                                                <div className="flex bg-slate-100 rounded-lg p-1 mb-6">
                                                    <button onClick={() => setDimensionMode('paper')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${dimensionMode === 'paper' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>標準紙張</button>
                                                    <button onClick={() => setDimensionMode('pixel')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${dimensionMode === 'pixel' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>自訂像素</button>
                                                </div>
                                                
                                                {dimensionMode === 'pixel' ? (
                                                    <div className="space-y-5 animate-fade-in">
                                                        <div>
                                                            <label className="block text-sm font-medium text-slate-600 mb-1.5">最大邊長限制 (px)</label>
                                                            <input type="number" value={maxWidth} onChange={(e) => setMaxWidth(Number(e.target.value))} className="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm font-medium text-slate-600 mb-1.5 flex justify-between">
                                                                <span>基礎解析度倍率</span>
                                                                <span className="text-blue-600 font-bold">{baseScale}x</span>
                                                            </label>
                                                            <input type="range" min="1" max="4" step="0.5" value={baseScale} onChange={(e) => setBaseScale(Number(e.target.value))} className="w-full accent-blue-600 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                                                            <div className="flex justify-between text-xs text-slate-400 mt-1"><span>1x</span><span>4x</span></div>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="space-y-5 animate-fade-in">
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <div>
                                                                <label className="block text-sm font-medium text-slate-600 mb-1.5">目標紙張</label>
                                                                <select value={selectedPaper} onChange={(e) => setSelectedPaper(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                                                    {Object.keys(PAPER_SIZES).map(size => (<option key={size} value={size}>{size}</option>))}
                                                                </select>
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm font-medium text-slate-600 mb-1.5">解析度 (DPI)</label>
                                                                <select value={selectedDPI} onChange={(e) => setSelectedDPI(Number(e.target.value))} className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                                                    {DPI_OPTIONS.map(opt => (<option key={opt.value} value={opt.value}>{opt.label}</option>))}
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div className="bg-blue-50 text-blue-800 text-xs p-3 rounded-lg border border-blue-100">
                                                            <strong>預估尺寸:</strong> {getPaperDimensionsText()}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    {/* Action Area */}
                                    <div className="flex flex-col items-center justify-center pt-6 pb-2">
                                        {error && <div className="mb-4 text-red-600 bg-red-50 border border-red-100 px-4 py-3 rounded-lg flex items-center gap-2 w-full max-w-lg justify-center"><IconAlert /> {error}</div>}
                                        
                                        {!result ? (
                                            <button 
                                                onClick={startConversion} 
                                                disabled={isProcessing} 
                                                className={`
                                                    px-10 py-3.5 rounded-xl text-white font-bold shadow-lg shadow-blue-200 flex items-center gap-3 text-lg transition-all transform
                                                    ${isProcessing ? 'bg-slate-400 cursor-not-allowed shadow-none' : 'bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 hover:-translate-y-1'}
                                                `}
                                            >
                                                {isProcessing ? 
                                                    <><div className="loader"></div><span>{progress.message} ({Math.round((progress.current / progress.total) * 100) || 0}%)</span></> : 
                                                    <><IconCheck /> 開始轉換</>
                                                }
                                            </button>
                                        ) : (
                                            <div className="w-full bg-green-50 border border-green-200 rounded-xl p-8 flex flex-col items-center animate-fade-in shadow-sm">
                                                <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center text-green-600 mb-4 text-3xl shadow-sm border border-green-200">
                                                    <IconCheck />
                                                </div>
                                                <h3 className="text-2xl font-bold text-green-800 mb-1">轉換完成！</h3>
                                                <p className="text-green-600 mb-8">{result.type === 'single' ? '已生成單張 JPG 影像' : '已將多張影像打包為 ZIP 壓縮檔'}</p>
                                                
                                                <div className="flex flex-col sm:flex-row gap-4 w-full sm:w-auto">
                                                    <a 
                                                        href={result.url} 
                                                        download={result.filename} 
                                                        className="px-8 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold shadow-lg shadow-green-200 flex items-center justify-center gap-2 transition-all hover:-translate-y-0.5"
                                                    >
                                                        <IconDownload /> 下載檔案
                                                    </a>
                                                    <button 
                                                        onClick={() => setResult(null)} 
                                                        className="px-8 py-3 bg-white border border-green-200 text-green-700 hover:bg-green-50 rounded-xl font-bold transition-colors"
                                                    >
                                                        繼續轉換
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
